{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block header %}

    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="{% url "home" %}">StackUp</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li{% if selected == "home" %} class="active"{% endif %}>
                <a href="{% url "home" %}">Home</a>
            </li>
            <li{% if selected == "about" %} class="active"{% endif %}>
                <a href="{% url "about" %}">About</a>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    
<link rel="stylesheet" type="text/css" href="../../static/css/style.css">
{% endblock %}

{% block body %}
    <div id="map-container">
	<div id="info">
                <span id="latspan"></span>
		<br />
                <span id="lngspan"></span>
		<br />
		<span id="rating"></span>
		<br />
		<span id="locName"></span>
		<br />
		<span id="avgRent"></span>
		<br />
		<span id="walkScore"></span>
        </div>
        <div id="map-canvas"></div>
    </div>
{% endblock body %}

{% block script %}
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtjo0LUoozL6LlvBy8lp-Gp7PElI4T_1M&sensor=true"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/fuzzyset.js"></script>
<script type="text/javascript">
function GetUrlValue(VarSearch){
    var SearchString = window.location.search.substring(1);
    var VariableArray = SearchString.split('&');
    for(var i = 0; i < VariableArray.length; i++){
        var KeyValuePair = VariableArray[i].split('=');
        if(KeyValuePair[0] == VarSearch){
            return KeyValuePair[1];
        }
    }
}

var initialLocation;

function initialize() {
    var region_array = {};
    var fuzzy_strings = [];
    {% for standard in standards %}
    region_array["{{ standard.region.name }}"] = {
        'name': '{{ standard.region.name }}',
        'avg_rent': '{{ standard.region.cl_rent }}',
        'star_level':'{{ standard.star_level }}',
        'threshold': '{{ standard.threshold }}'
    };
    fuzzy_strings.push("{{ standard.region.name }}");
    {% endfor %}
    fuzzy = FuzzySet(fuzzy_strings);


    var opts = {'center': new google.maps.LatLng(37.774514, -122.433414),
        'zoom':13, 'mapTypeId': google.maps.MapTypeId.ROADMAP }

    var map = new google.maps.Map(document.getElementById('map-canvas'),opts);
    google.maps.event.addListener(map,'click',function(event) {
        google.maps.event.addListener(map,'mousemove',function(event) {
                document.getElementById('latspan').innerHTML = event.latLng.lat()
                document.getElementById('lngspan').innerHTML = event.latLng.lng()

                $.ajax({
                    type: "GET",
                    url: "http://maps.googleapis.com/maps/api/geocode/json?latlng="+event.latLng.lat()+","+event.latLng.lng()+"&sensor=true",
                    dataType: "json",
                    success: function(json) {
                        matches = fuzzy.get(json.results[0].address_components[2].long_name);
                        $('#avgRent').text(region_array[matches[0][1]]['avg_rent']);
                        $('#rating').text(region_array[matches[0][1]]['star_level']);
                    }
                });
        });

});
}

function jsonParser(json) {
    console.log(json.results[0].address_components[2].long_name);
};
google.maps.event.addDomListener(window, 'load', initialize);
</script>
{% endblock %}
